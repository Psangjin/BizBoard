<?xml version="1.0" encoding="UTF-8"?> 
<!DOCTYPE mapper PUBLIC
		   "-//mybatis.org//DTD Mapper 3.0//EN" 
		   "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
		   
<mapper namespace="project_mapper">

	<insert id="createProject" parameterType="Project">
        <!-- 시퀀스 값 미리 가져오기 -->
        <selectKey keyProperty="id" order="BEFORE" resultType="long">
            SELECT project_seq.NEXTVAL FROM dual
        </selectKey>

        INSERT INTO t_project (
            id, manager, title, content, start_dt, end_dt
        ) VALUES (
            #{id},
            #{manager},
            #{title},
            #{content},
            #{startDt},
            #{endDt}
        )
    </insert>
	
	
	<select id="findAllProjects" resultType="Project">
		SELECT * FROM t_project
	</select>
	
	<select id="findProjectById" resultType="Project" parameterType="Long">
		SELECT * FROM t_project
		where id = #{projectId}
	</select>
	
	<select id="findProjectsByUserId" resultType="Project" parameterType="String">
		SELECT p.*
  FROM project_member m
  JOIN t_project p ON m.project_id = p.id
  WHERE m.user_id = #{userId}
	</select>
	
	  <!-- 프로젝트 업데이트 (동적) -->
  <update id="updateProject" parameterType="com.app.dto.project.Project">
    UPDATE t_project
       <set>
         <if test="manager != null"> manager = #{manager}, </if>
         <if test="title   != null"> title   = #{title},   </if>
         <if test="content != null"> content = #{content}, </if>
         <if test="endDt   != null"> end_dt  = #{endDt},   </if>
       </set>
     WHERE id = #{id}
  </update>
  
    <!-- 삭제 -->
  <delete id="deleteProject" parameterType="long">
    DELETE FROM t_project WHERE id = #{id}
  </delete>
  
  <!-- caller(변경한 사람)가 ADMIN인지 검사 -->
  <select id="isAdmin" parameterType="map" resultType="int">
    SELECT CASE WHEN COUNT(*) > 0 THEN 1 ELSE 0 END
      FROM t_project_member
     WHERE project_id = #{projectId}
       AND user_id    = #{userId}
       AND role       = 'ADMIN'
  </select>

	<select id="countNumberofScheduleByProjectId" resultType="int" parameterType="map">
	select count(*) from schedule
	where project_id=#{projectId}
	and type=#{type}
	</select>
	
	<select id="countNumberofScheduleDoneByProjectId" resultType="int" parameterType="map">
	select count(*) from schedule
	where project_id=#{projectId} AND completed = 'Done'
	and type=#{type}
	</select>
	
</mapper>